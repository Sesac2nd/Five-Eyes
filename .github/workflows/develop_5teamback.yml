name: Deploy Backend to Azure

on:
  push:
    branches:
      - develop
    paths:
      - 'Backend/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Python ì„¤ì¹˜
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3. ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (PaddleOCR ì™„ì „ ì§€ì›)
      - name: Install system dependencies for PaddleOCR
        run: |
          sudo apt update
          # ê¸°ë³¸ OpenGL ë° ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬
          sudo apt-get -y install \
            libgl1-mesa-glx \
            libgl1-mesa-dri \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1
          
          # OpenCV ë° ë¹„ë””ì˜¤ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬
          sudo apt-get -y install \
            libgtk-3-0 \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libv4l-dev \
            libxvidcore-dev \
            libx264-dev

      # 4. Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Python dependencies
        working-directory: ./Backend
        run: |
          python -m pip install --upgrade pip
          # PaddlePaddle CPU ë²„ì „ ë¨¼ì € ì„¤ì¹˜
          python3 -m pip install paddlepaddle==3.1.0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
          # ë‚˜ë¨¸ì§€ ì˜ì¡´ì„± ì„¤ì¹˜
          pip install -r requirements.txt

      # 5. í•µì‹¬ íŒ¨í‚¤ì§€ ê²€ì¦
      - name: Verify core installations
        working-directory: ./Backend
        run: |
          echo "=== ğŸ”§ ê¸°ë³¸ íŒ¨í‚¤ì§€ ê²€ì¦ ==="
          python -c "import fastapi; print('âœ… FastAPI:', fastapi.__version__)"
          python -c "import uvicorn; print('âœ… Uvicorn:', uvicorn.__version__)"
          python -c "import gunicorn; print('âœ… Gunicorn:', gunicorn.__version__)"
          
          echo "=== ğŸ¤– AI/ML íŒ¨í‚¤ì§€ ê²€ì¦ ==="
          python -c "
          try:
              import paddle
              print('âœ… Paddle:', paddle.__version__)
              print('ğŸ”§ Paddle ì„¤ì • í™•ì¸...')
              paddle.set_flags({
                  'FLAGS_fraction_of_cpu_memory_to_use': 0.5,
                  'FLAGS_eager_delete_tensor_gb': 0.0,
                  'FLAGS_fast_eager_deletion_mode': True,
                  'FLAGS_use_mkldnn': False,
              })
              print('âœ… Paddle ì„¤ì • ì™„ë£Œ')
          except Exception as e:
              print('âŒ Paddle ì‹¤íŒ¨:', e)
              exit(1)
          "

      # 6. PaddleOCR ì‹¬í™” ê²€ì¦
      - name: Deep verification of PaddleOCR
        working-directory: ./Backend
        run: |
          echo "=== ğŸ“„ PaddleOCR ë° ì˜ì¡´ì„± ê²€ì¦ ==="
          python -c "
          import os
          os.environ['KMP_DUPLICATE_LIB_OK'] = 'TRUE'
          
          try:
              # í•„ìˆ˜ ì˜ì¡´ì„± í™•ì¸
              import cv2
              print('âœ… OpenCV:', cv2.__version__)
              
              import numpy as np
              print('âœ… NumPy:', np.__version__)
              
              from sklearn.cluster import DBSCAN
              print('âœ… scikit-learn DBSCAN ì„í¬íŠ¸ ì„±ê³µ')
              
              from PIL import Image
              print('âœ… PIL/Pillow ì„í¬íŠ¸ ì„±ê³µ')
              
              # PaddleOCR ì„í¬íŠ¸ ë° ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸
              from paddleocr import PaddleOCR
              print('âœ… PaddleOCR ì„í¬íŠ¸ ì„±ê³µ')
              
              # ì‹¤ì œ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ ì„¤ì •ìœ¼ë¡œ)
              print('ğŸ”§ PaddleOCR ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸...')
              ocr = PaddleOCR(
                  lang='chinese_cht',
                  use_angle_cls=False,
                  enable_mkldnn=False,
                  cpu_threads=1,
                  show_log=False
              )
              print('âœ… PaddleOCR ì´ˆê¸°í™” ì„±ê³µ!')
              
          except Exception as e:
              print('âŒ PaddleOCR ê²€ì¦ ì‹¤íŒ¨:', e)
              import traceback
              traceback.print_exc()
              exit(1)
          "

      # 7. OCR ì„œë¹„ìŠ¤ í†µí•© í…ŒìŠ¤íŠ¸
      - name: Test OCR Service Integration
        working-directory: ./Backend
        run: |
          echo "=== ğŸ” OCR ì„œë¹„ìŠ¤ í†µí•© í…ŒìŠ¤íŠ¸ ==="
          python -c "
          import sys
          sys.path.append('.')
          try:
              from services.ocr_service import get_available_engines
              engines = get_available_engines()
              print(f'ğŸ”§ ì‚¬ìš© ê°€ëŠ¥í•œ OCR ì—”ì§„: {engines}')
              
              # PaddleOCR ì—”ì§„ì´ í™œì„±í™”ë˜ì–´ì•¼ í•¨
              if not engines.get('paddle', False):
                  print('âŒ PaddleOCR ì—”ì§„ì´ ë¹„í™œì„±í™”ë¨!')
                  exit(1)
              
              # Azure OCRë„ í™•ì¸
              if not engines.get('azure', False):
                  print('âš ï¸ Azure OCR ì—”ì§„ ë¹„í™œì„±í™”ë¨ (í™˜ê²½ë³€ìˆ˜ í™•ì¸ í•„ìš”)')
              
              print('âœ… OCR ì„œë¹„ìŠ¤ í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ!')
              
          except Exception as e:
              print(f'âŒ OCR ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          "

      # 8. ìµœì¢… Azure íŒ¨í‚¤ì§€ í™•ì¸
      - name: Verify Azure integrations
        working-directory: ./Backend
        run: |
          echo "=== â˜ï¸ Azure ì„œë¹„ìŠ¤ íŒ¨í‚¤ì§€ ê²€ì¦ ==="
          python -c "
          try:
              from azure.cognitiveservices.speech import SpeechConfig
              print('âœ… Azure Speech Service ì„í¬íŠ¸ ì„±ê³µ')
              
              from azure.ai.formrecognizer import DocumentAnalysisClient
              print('âœ… Azure Form Recognizer ì„í¬íŠ¸ ì„±ê³µ')
              
              from azure.search.documents import SearchClient
              print('âœ… Azure Search Service ì„í¬íŠ¸ ì„±ê³µ')
              
              print('âœ… ëª¨ë“  Azure ì„œë¹„ìŠ¤ íŒ¨í‚¤ì§€ ì •ìƒ!')
              
          except Exception as e:
              print('âš ï¸ Azure íŒ¨í‚¤ì§€ í™•ì¸:', e)
              print('(í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ë„ ì •ìƒì ì¸ ê²½ìš°ì¼ ìˆ˜ ìˆìŒ)')
          "

      # 9. ìµœì¢… í—¬ìŠ¤ì²´í¬ ì‹œë®¬ë ˆì´ì…˜
      - name: Simulate health check
        working-directory: ./Backend
        run: |
          echo "=== ğŸ’Š í—¬ìŠ¤ì²´í¬ ì‹œë®¬ë ˆì´ì…˜ ==="
          python -c "
          import sys
          sys.path.append('.')
          
          # í™˜ê²½ë³€ìˆ˜ ì²´í¬ ì—†ì´ ì„œë¹„ìŠ¤ ìƒíƒœë§Œ í™•ì¸
          try:
              from services.ocr_service import get_available_engines
              ocr_engines = get_available_engines()
              
              health_status = {
                  'ocr': {
                      'paddle_ocr': {
                          'available': ocr_engines.get('paddle', False),
                          'status': 'âœ“' if ocr_engines.get('paddle', False) else 'âœ—'
                      },
                      'azure_ocr': {
                          'available': ocr_engines.get('azure', False),
                          'status': 'âœ“' if ocr_engines.get('azure', False) else 'âœ—'
                      }
                  }
              }
              
              print(f'ğŸ’Š ìµœì¢… í—¬ìŠ¤ì²´í¬ ê²°ê³¼: {health_status}')
              
              if not health_status['ocr']['paddle_ocr']['available']:
                  print('âŒ PaddleOCRì´ ë¹„í™œì„±í™”ë¨! ë°°í¬ ì¤‘ë‹¨')
                  exit(1)
              
              print('âœ… í—¬ìŠ¤ì²´í¬ í†µê³¼! ë°°í¬ ì§„í–‰ ê°€ëŠ¥')
              
          except Exception as e:
              print(f'âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: {e}')
              exit(1)
          "

      # 10. Azure App Serviceë¡œ ë°°í¬
      - name: Deploy to Azure WebApp
        uses: azure/webapps-deploy@v2
        with:
          app-name: 5teamback
          slot-name: production
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_A989F9A786414385B17B295DCA209E37 }}
          package: ./Backend
